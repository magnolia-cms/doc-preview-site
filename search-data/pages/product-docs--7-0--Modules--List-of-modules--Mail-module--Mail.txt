---
title: "Mail"
url: https://docs.magnolia-cms.com/product-docs/7.0/Modules/List-of-modules/Mail-module/Mail/
category: Magnolia 6.4
version: latest
breadcrumb: DX Core > Modules > Mail module > Mail
---

# Mail

The [Mail module](../../../../../RNs-6-4-3/Modules/List-of-modules/Mail-module/) enables the sending of emails from within Magnolia. The module can be used to send plain text and HTML messages, and template-based messages.

Sending emails from Magnolia is typically an automated process. An event acts as a trigger. For example, a verification message is sent to a user when they fill a registration form.

Other Magnolia modules (such as [Form](../../../../../RNs-6-4-3/Modules/List-of-modules/Form-module/), [Observation](../../../../../RNs-6-4-3/Modules/List-of-modules/Observation-module/), and [Public User Registration](../../../../../RNs-6-4-3/Modules/List-of-modules/Public-User-Registration-module/)) use the Mail module for messaging.

| Node name |
| --- |
| üìÅ modules |
| üìÅ mail |
| üìÅ apps |
| üìÅ fieldTypes |
| üìÅ config |
| üìÅ commands |

| Node name | Values |
| --- | --- |
| üìÅ modules |  |
| üìÅ mail |  |
| üìÅ commands |  |
| üìÅ default |  |
| ‚∏¨ sendMail |  |
| ‚¨© class | info.magnolia.module.mail.commands.MailCommand |

## [](#_configuring_smtp)Configuring SMTP

The default transfer protocol (SMTP) settings are configured in `/modules/mail/config/smtpConfiguration`. Add your SMTP settings via decorations on the module‚Äôs config file: `/mail-config/decorations/mail/config.yaml`. Below are some commonly used configuration examples.

> **Tip:** For OAuth 2.0-related information, see also these external resources:GoogleOAuth 2.0 MechanismUsing OAuth 2.0 to Access Google APIsMicrosoftMicrosoft identity platform and OAuth 2.0 authorization code flow

Username and password decoration example

```yaml
smtpConfiguration:
  port: 465
  security: ssl
  server: smtp.gmail.com
  authentication:
    class: info.magnolia.module.mail.smtp.authentication.UsernamePasswordSmtpAuthentication
    passwordKeyStoreId: uuid-of-password-in-password-app-stored-in-keystore-workspace
    user: email@example.com
```

To use the Google username/password example decoration below, you must enable [Less secure apps](https://support.google.com/accounts/answer/6010255).

Decoration file for Google SMTP with OAuth

```yaml
smtpConfiguration:
  port: 465
  security: tls
  server: smtp.gmail.com
  authentication:
    class: info.magnolia.module.mail.smtp.authentication.GoogleOauthSmtpAuthentication
    clientId: client-id
    clientSecretKeyStoreId: uuid-of-secret-key-in-password-app-stored-in-keystore-workspace
    refreshTokenKeyStoreId: uuid-of-refresh-token-in-password-app-stored-in-keystore-workspace
    user: email@example.com
```

### [](#_using_client_credentials_grant_flow_to_authenticate_smtp_connections)Using client credentials grant flow to authenticate SMTP connections

This section outlines the key configuration steps for Magnolia to access mailboxes in Microsoft Exchange. The client credentials grant flow is used to obtain access tokens over SMTP. These tokens enable secure, application-level access to email without requiring user interaction for authentication. For more information, see the [Microsoft legacy protocols](https://learn.microsoft.com/en-us/exchange/client-developer/legacy-protocols/how-to-authenticate-an-imap-pop-smtp-application-by-using-oauth#use-client-credentials-grant-flow-to-authenticate-smtp-imap-and-pop-connections) documentation.

To configure Microsoft Exchange for Magnolia:

1.  In the Azure portal, grant your Microsoft Entra application the necessary `SMTP.SendAsApp` permission.

2.  Get tenant admin consent for Magnolia.

    This can be done via an authorization request URL (for multi-tenant applications) or directly through the Microsoft Entra admin center (for single-tenant applications).

3.  Register service principals in Exchange: Use the `New-ServicePrincipal` cmdlet in Exchange Online PowerShell to register your Entra application‚Äôs service principal within Exchange.

4.  Grant mailbox permissions.

    Use the `Add-MailboxPermission` cmdlet to specify which mailboxes your application‚Äôs service principal can access.

5.  Access mailboxes in the Mail module.

    Your Microsoft Entra application can now access the configured mailboxes over SMTP with the OAuth 2.0 client credentials grant flow. Ensure that you use `[https://outlook.office365.com/.default](https://outlook.office365.com/.default)` in the scope property for the access token request.


### [](#_refreshing_access_tokens_for_google_oauth_2_0)Refreshing access tokens for Google OAuth 2.0

The **Google OAuth 2.0** authentication type supported by the Mail module leverages *OAuth 2.0 Client IDs*. This type by default requires user interaction, which doesn‚Äôt readily suit the use case of sending emails automatically.

As a workaround for this limitation, you can follow the procedure described in [Refreshing an access token (offline access)](https://developers.google.com/identity/protocols/oauth2/web-server#offline). You can use the [Postman](https://www.postman.com) to refresh a token.

Click to see the details.

1.  Open the Postman app.

2.  Create a new request.

3.  On the Authorization tab, choose **OAuth 2.0** as the authorization type.

4.  In the Grant Type field, select **Authorization Code**.

5.  In the Callback URL part, check **Authorize using browser**.

6.  In the Auth URL field, enter `https://accounts.google.com/o/oauth2/v2/auth?access_type=offline&prompt=consent`.

7.  In the Access Token URL field, enter `https://oauth2.googleapis.com/token`.

8.  In the Client ID and Client Secret fields, input your client id and client secret, respectively.

9.  In the Scope field, enter `https://mail.google.com/`.

10.  Click the Get New Access Token button.


![OAuth2 settings](../../../../../RNs-6-4-3/_images/image-OAuth2-settings.png)

After this, the browser opens a form where you can sign in and then refresh the token.

![Refresh token](../../../../../RNs-6-4-3/_images/image-refresh-token.png)

There are other ways of obtaining a refresh token, for example [Exchange authorization code for refresh and access tokens](https://developers.google.com/identity/protocols/oauth2/web-server#exchange-authorization-code).

> **Note:** Development work is underway to support Service Accounts for Google OAuth 2.0 in Magnolia (MGNLMAIL-205, restricted access). This authentication type is designed for server-to-server communication and fits best for the Mail module use case. Its configuration is simpler and without the need to configure a refresh token.

Decoration file for Microsoft SMTP with OAuth

```yaml
smtpConfiguration:
  port: 587
  security: tls
  server: smtp.office365.com
  authentication:
    class: info.magnolia.module.mail.smtp.authentication.MicrosoftOauthSmtpAuthentication
    clientId: client-id
    tenantId: tenant-id
    clientSecret: uuid-of-client-secret-in-password-app-stored-in-keystore-workspace
    user: email@example.com
```

> **Tip:** To get the UUID of an item:Open the JCR app.Choose the workspace, for content handled by the Passwords app the keystore workspace.Click the Display system properties checkbox.You can now see system properties in the JCR tree, including the jcr:uuid property.

### [](#_ssl_protocol_version)SSL protocol version

Since version `5.5.13` of the Mail module, you can use the optional `sslProtocols` property to set the version of the SSL protocol(s) to be used. The property value is a whitespace-separated list of tokens, for example:

```properties
sslProtocols: TLSv1.1 TLSv1.2
```

## [](#_verifying_setup)Verifying setup

You can verify your setup with the Groovy app. In the Groovy app, you should see the `sendMail` script.

1.  Set the `sender` and `recipient` you want.

2.  Click the **Run** button to send the test mail.


> **Note:** If your Groovy app doesn‚Äôt have the sendMail script, you can add one like the script below to test your setup.// Email
> sender = "your-sender-mail@test.com"
> recipient = "your-receiver-mail@test.com"
>
> mailModule = info.magnolia.objectfactory.Components.getComponent(info.magnolia.module.mail.MailModule)
> mailFactory = mailModule.getFactory()
>
> email = mailFactory.getEmail([:], [])
> email.setFrom(sender)
> email.setToList(recipient)
> email.setSubject("Test Mail")
> email.setBody("Test email from the Groovy console!")
>
> println "Sending mail.... "
> mailFactory.getEmailHandler().sendMail(email)
>
> println "Done!"

## [](#_smtp_connection_timeout)SMTP connection timeout

Using the `timeoutInMillis` setting on the SMTP configuration will define when a connection attempt to the server times out.

To set connection timeout:

1.  From the Configuration app, find the SMTP configuration node (`/modules/mail/config/smtpConfiguration`).

2.  Add a `timeoutInMillis` property and set its value accordingly. The default value is `5000` (milliseconds).


## [](#_smtp_session_debugging)SMTP session debugging

Using the `debug` setting on the SMTP configuration will enable a dump of the session data to system out.

> **Note:** The session debug is only shown in the standard output and not printed to the log file.

To enable session debugging:

1.  From the Configuration app, find the SMTP configuration node (`/modules/mail/config/smtpConfiguration`).

2.  Add a `debug` property and set its value to `true`.

3.  From the console see the detailed session debug data.

    Click to see a debug data.

    ```text
    DEBUG: setDebug: JavaMail version 1.6.2
    2020-05-04 18:07:25,329 DEBUG info.magnolia.module.mail.templates.MgnlEmail : Set attachments [0] for mail: [info.magnolia.module.mail.templates.impl.FreemarkerEmail]
    DEBUG: getProvider() returning javax.mail.Provider[TRANSPORT,smtp,com.sun.mail.smtp.SMTPTransport,Oracle]
    DEBUG SMTP: need username and password for authentication
    DEBUG SMTP: protocolConnect returning false, host=smtp.mail.ch, user=magnolia.cms, password=<null>
    DEBUG SMTP: useEhlo true, useAuth true
    DEBUG SMTP: trying to connect to host "smtp.mail.ch", port 465, isSSL true
    220 smtp01.mail.ch ESMTP
    DEBUG SMTP: connected to host "smtp.mail.ch", port: 465
    EHLO localhost
    250-smtp01.mail.ch
    250-PIPELINING
    250-SIZE 160000000
    250-AUTH PLAIN LOGIN
    250-AUTH=PLAIN LOGIN
    250-ENHANCEDSTATUSCODES
    250 DSN
    DEBUG SMTP: Found extension "PIPELINING", arg ""
    DEBUG SMTP: Found extension "SIZE", arg "160000000"
    DEBUG SMTP: Found extension "AUTH", arg "PLAIN LOGIN"
    DEBUG SMTP: Found extension "AUTH=PLAIN", arg "LOGIN"
    DEBUG SMTP: Found extension "ENHANCEDSTATUSCODES", arg ""
    DEBUG SMTP: Found extension "DSN", arg ""
    DEBUG SMTP: protocolConnect login, host=smtp.mail.ch, user=magnolia.cms, password=<non-null>
    DEBUG SMTP: Attempt to authenticate using mechanisms: LOGIN PLAIN DIGEST-MD5 NTLM XOAUTH2
    DEBUG SMTP: Using mechanism LOGIN
    DEBUG SMTP: AUTH LOGIN command trace suppressed
    DEBUG SMTP: AUTH LOGIN succeeded
    DEBUG SMTP: use8bit false
    MAIL FROM:<magnolia.cms@mail.ch>
    250 2.1.0 Ok
    RCPT TO:<magnolia.cms@mail.ch>
    250 2.1.5 Ok
    RCPT TO:<magnolia.cms@mail.ch>
    250 2.1.5 Ok
    DEBUG SMTP: Verified Addresses
    DEBUG SMTP: magnolia.cms@mail.ch
    DEBUG SMTP: magnolia.cms@mail.ch
    DATA
    354 End data with <CR><LF>.<CR><LF>
    Date: Mon, 4 May 2020 18:07:25 +0200 (CEST)
    From: magnolia.cms@mail.ch
    To: magnolia.cms@mail.ch, magnolia.cms@mail.ch
    Message-ID: <1617772963.1.1588608445333@localhost>
    Subject: This is a test email for freemarker template
    MIME-Version: 1.0
    Content-Type: text/html; charset=UTF-8
    Content-Transfer-Encoding: 7bit

    <h1></h1>
    <img src="cid:0001"/>

    This is the path that has been changed:

    .
    250 2.0.0 Ok: queued as CCE8A10036F
    DEBUG SMTP: message successfully delivered to mail server
    QUIT
    221 2.0.0 Bye
    2020-05-04 18:07:26,080 INFO fo.magnolia.module.mail.handlers.SimpleMailHandler: Mail has been sent to: [magnolia.cms@example.com, magnolia.cms@example.com]
    ```


| Node name | Value |
| --- | --- |
| üìÅ config |  |
| üìÅ templatesConfiguration |  |
| ‚∏¨ testFreemarker |  |
| ‚∏¨ attachments |  |
| ‚∏¨ parameters |  |
| ‚¨© contentType | html |
| ‚¨© from | [testfreemarker@example.com](mailto:testfreemarker@example.com) |
| ‚¨© subject | This is a test email for freemarker template |
| ‚¨© templateFile | testFreemarker.html |
| ‚¨© type | freemarker |
| ‚∏¨ pageCommentsNotification |  |

| Node name | Value |
| --- | --- |
| üìÅ config |  |
| ‚∏¨ factory |  |
| ‚∏¨ renderers |  |
| ‚¨© freemarker | info.magnolia.module.mail.templates.impl.FreemarkerEmail |
| ‚¨© magnolia | info.magnolia.module.mail.templates.impl.MgnlPageEmail |
| ‚¨© simple | info.magnolia.module.mail.templates.impl.SimpleEmail |
| ‚¨© class | info.magnolia.module.mail.MgnlMailFactory |

## [](#_template_script)Template script

Here‚Äôs the example `testFreemarker.html` template script.

```xml
<h1>${user}</h2.
    <img src="cid:0001"/>
    This is the path that has been changed: ${path}
```

This script requires two parameters, `user` and `path`, that need to be provided in the **Data to send** box in the [Verify templates tool](#_message_templates). The parameters are passed to the template script and rendered in the message. Each parameter should be added on a single line in the `<parameter name=<value>` format.

For example:

```properties
user=jsmith
path=/my/path
```

| Node name | Value |
| --- | --- |
| ‚∏¨ testFreemarker |  |
| ‚∏¨ attachments |  |
| ‚∏¨ 0001 |  |
| ‚¨© cid | img |
| ‚¨© url | http://www.magnolia-cms.com/.imaging/amplify-miami-2014/imageForTeaserBinary/miami.png |

| Node name | Value |
| --- | --- |
| üìÅ config |  |
| üìÅ templatesConfiguration |  |
| ‚∏¨ newUserRegistration |  |
| ‚∏¨ attachments |  |
| ‚∏¨ parameters |  |
| ‚¨© contentType | html |
| ‚¨© from | info@registrations.com |
| ‚¨© subject | New User Registration |
| ‚¨© templateFile | <your-light-module>/templates/simpleTemplate.html |
| ‚¨© type | freemarker |
