---
title: "mParticle CDP extension"
url: https://docs.magnolia-cms.com/cdp-integration-framework/mparticle/
category: Modules
version: modules
breadcrumb: CDP integration framework > mParticle CDP extension
---

# mParticle CDP extension

[Customer data](../../product-docs/RNs-6-4-3/use-cases/customer-data/) [Unbundled: Extension](https://gitlab.magnolia-platform.com/ps/incubator/customer-data-platform) Version [3.0.1](https://magnolia-cms.atlassian.net/browse/CUSTDP)

The **mParticle CDP extension** module integrates Magnolia with [mParticle](https://www.mparticle.com/) (a customer data platform) to facilitate personalization.

> **Important:** You need the following mParticle credentials. Please contact mParticle to obtain this information.platform_key for Web SDK integrationclient_id and client_secret for authenticationaccountId, orgId, and workspaceId for the Audiences (Platform API) and Profile APIFor more details:API Key VerificationCreating API Credentials

> **Important:** You should use the trait definition configuration. It’s also advised to disable the audienceDetector filter and the old trait named "mpAudiences".Filter: config -> /server/filters/audienceDetector
> Trait: /cdp-mparticle/traits/mpAudiences.yaml

## [](#_installing_with_maven)Installing with Maven

Maven is the easiest way to install the module. Add the following to your [bundle](../../product-docs/RNs-6-4-3/Developing/Bundles-and-webapps/):

```xml
<dependency>
  <groupId>info.magnolia.cdp</groupId>
  <artifactId>magnolia-cdp-mparticle</artifactId>
  <version>3.0.1</version>
</dependency>
```

> **Note:** For common use with a DX-Core bundle, you need to build a jar file and then copy it to lib folder.mv cdp-mparticle-3.0.1.jar tomcatDir/webapp/ROOT/WEB-INF/lib/

## [](#_configuration)Configuration

1.  Add and publish `client_secret` to the Passwords app for security best practices and copy the Password ID for later use.

    ![mparticle client secret](_images/mparticle-client-secret.png)

2.  Update `client_id` and `client_secret` for mParticle authentication via decoration in `<your-light-module>/decorations/cdp-mparticle/restClients/mparticle-authentication.yaml` file.

    mparticle-authentication.yaml

    ```yaml
    baseUrl: https://sso.auth.mparticle.com
    cacheConfiguration:
      expireIn: 60
    timeoutConfiguration:
      readTimeout: 5
      fallbackToCache: true
    restCalls:
      authenticate:
        method: POST
        path: '/oauth/token'
        # https://docs.magnolia-cms.com/product-docs/6.2/modules/list-of-modules/rest-client-module/#_hiding_sensitive_information
        body: '{"client_id":"<client_id>"},"client_secret":"{@password:<The Password ID in Password App>}","audience":"https://api.mparticle.com","grant_type":"client_credentials"}'
    ```

3.  Update `platform_key`, `accountId`, `orgId` ,and `workspaceId` via decoration in `<your-light-module>/decorations/cdp-mparticle/config.yaml` file.

    config.yaml

    ```yaml
    orgId: <mParticle org Id>
    accountId: <mParticle Account Id>
    workspaceId: <mParticle Workspace Id>
    platformKey: <mParticle Platform Key>
    ```

4.  Change `platform_key` in a JavaScript snippet for frontend integration by following [mParticle SDK Initialization]({https://docs.mparticle.com/developers/quickstart/web/create-input/#12-initialize-the-sdk})

    ```none
    ${mpfn.getPlatformKey()}
    ```

5.  Enable `Audiences Sync Job` and its [scheduler time]({https://freeformatter.com/cron-expression-generator-quartz.html}) by decoration in `<your-light-module>/decorations/scheduler/config.yaml` file.

    config.yaml

    ```yaml
    jobs:
     audiencesSyncJob:
       catalog: mparticle
       command: audiencesSync
       cron: '0 0 1 * * ?'
       description: 'Sync Audiences from mParticle - Every day at 1am'
       enabled: false
       params:
         cleanInActiveAudiences: 'true'
         disableNotification: 'true'
    ```


### [](#_trait_definition)Trait definition

To enable personalization based on user data from mParticle, define traits in your Magnolia light module’s personalization configuration. Traits map mParticle user audiences to personalization rules.

The following examples define traits for Audiences based on Magnolia standard traits: `cookieTrait` or `headerTrait`, `requestParameterTrait`.

Place this trait definition in your light module under the `traits` directory. For example, if your light module is named `my-cdp-module`, create the file at:

**<your-magnolia-project>/light-modules/my-cdp-module/traits/file-name.yaml**

-   mpAudienceCookie

-   mp-audiences-header

-   mpAudiencesRequestParameter


<your-magnolia-project>/light-modules/my-cdp-module/traits/mpAudiencesCookie.yaml

```yaml
name: mpAudiencesCookie (1)
$type: cookieTrait (2)
voterClass: info.magnolia.cdp.mparticle.personalization.traits.voter.NameAndMultiValueVoter
defaultRuleTrait: false
defaultPreviewTrait: false
ruleField:
  $type: comboBoxField
  name: value
  label: CDP mParticle Audience Cookie Trait
  datasource: &datasource (3)
    $type: jcrDatasource
    workspace: mparticle-audiences
    includeProperties: false
    allowedNodeTypes:
      - mgnl:mpAudience
    sortBy:
      jcrName: ascending
valueField:
  $type: comboBoxField
  label: CDP mParticle Audience Cookie Trait
  datasource: *datasource
traitStorageClass: info.magnolia.personalization.trait.storage.StorageAwareTraitCollector$RequestScopedTraitStorage (4)
```

|     |     |
| --- | --- |
| **1** | The `name` identifies the trait in personalization rules. |
| **2** | The `$type` indicates the trait is populated from a cookie or request header or request parameter (e.g., `?mpAudiencesRequestParameter=<Audiences>`). |
| **3** | List of Audiences from the **mParticle Audiences** content app. |
| **4** | The `traitStorageClass` stores the trait for the duration of the user’s request. This is ideal for temporary data like recent browsing activity. |

<your-magnolia-project>/light-modules/my-cdp-module/traits/mp-audiences-header.yaml

```yaml
name: mp-audiences-header (1)
$type: headerTrait (2)
voterClass: info.magnolia.cdp.mparticle.personalization.traits.voter.NameAndMultiValueVoter
defaultRuleTrait: false
defaultPreviewTrait: false
ruleField:
  $type: comboBoxField
  name: value
  label: CDP mParticle Audience Header Trait
  datasource: &datasource (3)
    $type: jcrDatasource
    workspace: mparticle-audiences
    includeProperties: false
    allowedNodeTypes:
      - mgnl:mpAudience
    sortBy:
      jcrName: ascending
valueField:
  $type: comboBoxField
  label: CDP mParticle Audience Header Trait
  datasource: *datasource
traitStorageClass: info.magnolia.personalization.trait.storage.StorageAwareTraitCollector$RequestScopedTraitStorage (4)
```

|     |     |
| --- | --- |
| **1** | The `name` identifies the trait in personalization rules. |
| **2** | The `$type` indicates the trait is populated from a cookie or request header or request parameter (e.g., `?mpAudiencesRequestParameter=<Audiences>`). |
| **3** | List of Audience from the **mParticle Audiences** content app |
| **4** | The `traitStorageClass` stores the trait for the duration of the user’s request. This is ideal for temporary data like recent browsing activity. |

<your-magnolia-project>/light-modules/my-cdp-module/traits/mpAudiencesRequestParameter.yaml

```yaml
name: mpAudiencesRequestParameter (1)
$type: requestParameterTrait (2)
voterClass: info.magnolia.cdp.mparticle.personalization.traits.voter.NameAndMultiValueVoter
defaultRuleTrait: false
defaultPreviewTrait: false
ruleField:
  $type: comboBoxField
  name: value
  label: CDP mParticle Audience RequestParameter Trait
  datasource: &datasource (3)
    $type: jcrDatasource
    workspace: mparticle-audiences
    includeProperties: false
    allowedNodeTypes:
      - mgnl:mpAudience
    sortBy:
      jcrName: ascending
valueField:
  $type: comboBoxField
  label: CDP mParticle Audience RequestParameter Trait
  datasource: *datasource
traitStorageClass: info.magnolia.personalization.trait.storage.StorageAwareTraitCollector$RequestScopedTraitStorage (4)
```

|     |     |
| --- | --- |
| **1** | The `name` identifies the trait in personalization rules. |
| **2** | The `$type` indicates the trait is populated from a cookie or request header or request parameter (e.g., `?mpAudiencesRequestParameter=<Audiences>`). |
| **3** | List of Audience from the **mParticle Audiences** content app |
| **4** | The `traitStorageClass` stores the trait for the duration of the user’s request. This is ideal for temporary data like recent browsing activity. |

> **Tip:** To verify, restart Magnolia and check the Personalization app in AdminCentral; the defined trait should appear in the trait selection dropdown.

## [](#_features)Features

-   Store audiences from mParticle in the **mParticle Audiences** content app.

    ![mparticle contentapp icon](_images/mparticle-contentapp-icon.png)

-   Fetch mParticle audiences instantly with the **Sync Audiences** action.

    ![mparticle contentapp](_images/mparticle-contentapp.png)

-   Use the [Scheduler module](../../product-docs/RNs-6-4-3/Modules/List-of-modules/Scheduler-module/) to fetch mParticle audiences with `audiencesSyncJob` (only run on author instances).

    config.yaml

    ```yaml
    jobs:
     audiencesSyncJob:
       catalog: mparticle
       command: audiencesSync
       cron: '0 0 1 * * ?'
       description: 'Sync Audiences from mParticle - Every day at 1am'
       enabled: false
       params:
         cleanInActiveAudiences: 'true'
         disableNotification: 'true'
    ```

-   Use the **mpAudiences** trait to display and configure audiences from the mParticle audiences app.

    ![mparticle audiences trait](_images/mparticle-audiences-trait.png)

    ![mparticle audiences trailt items](_images/mparticle-audiences-trailt-items.png)


### [](#_templating_functions)Templating functions

You can use the `mpfn` templating function with the following methods.

-   Get Platform Key `${mpfn.getPlatformKey()}`

-   Get User Profile Path `${mpfn.getUserProfilePath()}`


### [](#_rest_endpoints)REST endpoints

There are several REST endpoints you can use to fetch profiles and audiences.

> **Warning:** You must add the mparticle-profile-rest-role (for anonymous) and mparticle-rest-role (for administrator) role for the user calling REST.

#### [](#_get_mparticle_profile)Get mParticle profile

POST `.rest/mparticle/profile`

Request body:

```json
{
    "mpid": "<mpid>",
    "userprofile_path": "<OrgId>/<AccountId>/<workspaceId>"
}
```

#### [](#_get_all_audiences)Get all audiences

POST `.rest/mparticle/get-audiences`

Request body:

```json
{
    "accountId": "<accountId>" (1)
}
```

|     |     |
| --- | --- |
| **1** | This is your mParticle `accountId`. |

#### [](#_delete_an_audience)Delete an audience

POST `.rest/mparticle/delete-audience`

Request body:

```json
{
    "audienceId": "<audienceId>" (1)
}
```

|     |     |
| --- | --- |
| **1** | This is your mParticle `audienceId`. |

#### [](#_get_all_audiences_by_workspace)Get all audiences by workspace

POST `.rest/mparticle/get-audiences-workspace`

Request body:

```json
{
    "accountId": "<accountId>", (1)
    "workspaceId": "<workspaceId>" (2)
}
```

|     |     |
| --- | --- |
| **1** | This is your mParticle `accountId`. |
| **2** | This is your mParticle `workspaceId`. |

## [](#_usage)Usage

### [](#_variant_components)Variant components

Use [Component Personalization](../../product-docs/RNs-6-4-3/Features/Personalization/Component-personalization/) to set up a new variant component on your page. You can use Segment or Trait configuration.

![mparticle personalization](_images/mparticle-personalization.png)

### [](#_frontend_integration)Frontend integration

Perform frontend integration using the [mParticle Web SDK](https://docs.mparticle.com/developers/quickstart/web/overview/).

See `cdp-mparticle/templates` in the Resources app for a sample frontend integration.

### [](#_parse_mparticle_audiences)Parse mParticle audiences

Get User audiences from mParticle and parse the list into a string using `"|"` as a delimiter and save it to the **mpAudiences** cookie or header or requestParam.

```none
mpAudiences: 53730|53731|53730
```

![mparticle cookie](_images/mparticle-cookie.png)

Example

```js
<script>
    window.addEventListener('load', function() {
        var user = mParticle.Identity.getCurrentUser();
        const data = {
            "mpid": user.getMPID(),
            "userprofile_path": "${mpfn.getUserProfilePath()}"
        };
        console.log('mpid header', user.getMPID());
        Cookies.remove('mpAudiences');
        $.ajax({
            type: "POST",
            data: JSON.stringify(data),
            url: "${ctx.contextPath}/.rest/mparticle/profile",
            headers: {
                "Content-Type": "application/json",
            },
            success: function (data) {
                debugger;
                if (data.audience_memberships && data.audience_memberships.length > 0) {
                    console.log("audience_memberships form profile", data.audience_memberships);
                    Cookies.set('mpAudiences', data.audience_memberships.map(audience => audience.audience_id).join('|'), {
                        expires: 365
                    });
                    console.log("[Header] mpAudiences from cookies", Cookies.get('mpAudiences'));
                }
            },
            dataType: "json"
        });
    });
    window.addEventListener('load', function() {
        const url = new URL(window.location.toString());
        const pageTitle = url.pathname.replace("${ctx.contextPath}", "");
        mParticle.logPageView(
            pageTitle,
            {page: window.location.toString()},
            // if you're using Google Analytics to track page views
            {"Google.Page": window.location.pathname.toString(),
                "Google.Title": "FW from mParticle - ${content.windowTitle!content.title!}"
            }
        );
    });
</script>
```
