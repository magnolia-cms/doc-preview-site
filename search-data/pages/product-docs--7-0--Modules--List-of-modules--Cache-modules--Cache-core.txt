---
title: "Cache core"
url: https://docs.magnolia-cms.com/product-docs/7.0/Modules/List-of-modules/Cache-modules/Cache-core/
category: Magnolia 6.4
version: latest
breadcrumb: DX Core > Modules > Cache modules > Cache core
---

# Cache core

[Operations](../../../../use-cases/operations/) Bundled: Community edition

| Edition | CE, Cloud |
| --- | --- |
| License | [MLA](https://www.magnolia-cms.com/mla.html), [GPL](http://www.gnu.org/licenses/gpl-3.0.html) |
| Issues | [MGNLCACHE](https://magnolia-cms.atlassian.net/browse/MGNLCACHE) |
| Maven site | [Cache](https://nexus.magnolia-cms.com/#browse/browse:public:info%2Fmagnolia%2Fcache%2Fmagnolia-cache-core%2F7.0.0) |
| Latest | 7.0.0 |

Magnolia employs a web cache to store server responses so that future requests for the same content can be served faster. The chief benefit of using cache is a reduction in information load on the network, meaning less bandwidth used, reduced processing and improved responsiveness.

## [](#_installing_with_maven)Installing with Maven

Maven is the easiest way to install the module. Add the following to your [bundle](../../../../Developing/Bundles-and-webapps/):

```xml
<dependency>
  <groupId>info.magnolia.cache</groupId>
  <artifactId>magnolia-cache-core</artifactId>
  <version>7.0.0</version> (1)
</dependency>
```

|     |     |
| --- | --- |
| **1** | Should you need to specify the module version, do it using `<version>`. |

## [](#_disabling)Disabling

> **Warning:** Although the Cache module is bundled as a separate module, it is essential to Magnolia and many other modules depend on it. Donâ€™t uninstall the Cache module. If necessary, disable caching by adding an enabled node in Configuration > /server/filters/cache and set its value to false.

| Node name | Value |
| --- | --- |
| ðŸ“ server |     |
| ðŸ“ filters |     |
| ðŸ“ cache |     |
| â¬© defaultContentCachingConfigurationName | defaultPageCache |
| â¬© class | info.magnolia.module.cache.filter.CacheFilter |
| â¬© enabled | false |

## [](#_how_caching_works)How caching works

Caching is performed by the [Cache filter](../../../../Administration/Architecture/Request-processing-and-filters/Filters/), which is part of the standard Magnolia [filter chain](../../../../Administration/Architecture/Request-processing-and-filters/Filters/). When a request arrives to the Cache filter, the filter passes it to the browser cache policy.

-   **Content not modified**: If a client has the latest version of content (i.e. not modified), the browser cache policy instructs the filter to respond with `304 Not Modified`.

-   **Modified content**: If content has been modified or does not exist in the cache, the filter passes the request to the server cache policy. Server cache policy then analyzes the request and replies with the expected behavior. The filter then invokes the appropriate executor. This mechanism allows you to add, remove and use executors by changing the current cache policy.

-   **Content not available**: If the content is not available, the filter passes the request on to Magnolia. On the return trip, the filter reads the content from the response and stores it in the cache store for future use. Flush policy is completely independent of this chain and reacts on content changes rather than content served.


![Request processing and filter chain in Magnolia](../../../../_images/6-2-requestProcessing.png)

## [](#_configuration)Configuration

Cache configuration is defined in `/modules/cache/config/contentCaching/`. Within each configuration you can define:

-   What to cache.

-   When to flush the cache.

-   What header data to pass to browsers.

-   Specific implementations of tasks.


> **Tip:** See an overview of differences between FreeMarker and headless templating.

| Node name | Value |
| --- | --- |
| ðŸ“ modules |     |
| ðŸ“ cache |     |
| ðŸ“ config |     |
| ðŸ“ contentCaching |     |
| â¸¬ defaultPageCache |     |
| â¸¬ uuid-key-mapping |     |
| â¸¬ compression |     |
| â¸¬ cacheFactory |     |
| â¬© cacheResponseThreshold | 1000 |

> **Note:** The default value for cacheResponseThreshold is 500. For more information and configuration details, see the Cache threshold subsection below.

To select one of the cache configurations, set the `defaultContentCachingConfigurationName` parameter in the [Cache filter](../../../../Administration/Architecture/Request-processing-and-filters/Filters/). The chosen configuration is read into a JavaBean using the [Node2Bean mechanism](../../../../Administration/Architecture/Configuration-management/), making it dynamically available to your own module code.

| Node name | Value |
| --- | --- |
| ðŸ“ server |     |
| ðŸ“ filters |     |
| ðŸ“ cache |     |
| â¬© defaultContentCachingConfigurationName | defaultPageCache |
| â¬© class | info.magnolia.module.cache.filter.CacheFilter |

### [](#_policy_configuration)Policy configuration

Caching behavior for each configuration is defined with policies.

#### [](#_server_cache_policy)Server cache policy

This policy defines whether the requested content should be cached or not. The decision to cache relies on [voters](../../../../Administration/Voters/), which are used whenever configuration values arenâ€™t assigned at startup but depend on rules.

Voters evaluate a rule such as *should content residing at this URL be cached* and return a positive or negative response. By default, all content on public instances is cached except the AdminCentral UI at `/.magnolia`. Server cache policy is configured in `/modules/cache/config/contentCaching/defaultPageCache/cachePolicy`.

The default implementation (info.magnolia.module.cache.cachepolicy.Default) checks if the content exists in the cache store and requests caching if the content is not found. The alternative class (info.magnolia.module.cache.cachepolicy.Never) instructs the cache not to store the generated content. Server-side re-caching of no-cache requests (shift reload) is configurable and set to `false` by default.

| Node name | Value |
| --- | --- |
| â¸¬ defaultPageCache |     |
| â¸¬ cachePolicy |     |
| â¸¬ shouldBypassVoters |     |
| â¸¬ urls |     |
| â¸¬ deny |     |
| â¸¬ parameters |     |
| â¸¬ whitelist |     |
| â¬© 0 | ^utm\_.\*$ |
| â¸¬ resources |     |
| â¬© class | info.magnolia.module.cache.cachepolicy.Default |
| â¬© refreshOnNoCacheRequests | false |

##### [](#_whitelisting_specific_parameters)Whitelisting specific parameters

Since Magnolia 6.2.30, under `../shouldBypassVoters/deny/parameters/whitelist`, you can configure a key-value(regex) map of request parameters that should be ignored and hence their requests cached as a result.

As shown in the example above, the map configured there causes caching of all requests containing the `utm_`\* tracking tag(s), which could otherwise generate a high server load, for example when sending marketing mails or other material utilizing the `utm_`\* tracking tag(s).

##### [](#_cache_key_generator)Cache key generator

You can define a custom cache key generator or configure the default one to meet your needs.

|     |     |
| --- | --- |
| ðŸ“ cache |     |
| ðŸ“ config |     |
| ðŸ“ contentCaching |     |
| â¸¬ defaultPageCache |     |
| â¸¬ cachePolicy |     |
| â¸¬ shouldBypassVoters |     |
| â¸¬ ttlVoters |     |
| â¸¬ cacheKeyGenerator |     |
| â¬© useRequestParameters | false |
| â¬© class | info.magnolia.module.cache.cachekey.DefaultCacheKeyGenerator |
| â¬© class | info.magnolia.module.cache.cachepolicy.Default |

| Attribute | Default | Description |
| --- | --- | --- |
| `useUri` | `true` | Use URI as part of cache key. |
| `useRequestParameters` | `true` | Use request query as part of cache key. |
| `useRequestMethod` | `true` | Use request method (GET/POST/HEAD) as part of cache key. |
| `useRequestServerName` | `true` | Use server name as part of cache key. |
| `useRequestGetSecure` | `true` | Save information whether this request was made using a secure channel, such as HTTPS as part of cache key. |
| `useUserName` | `true` | Use user name as part of cache key. |
| `useLocale` | `true` | Use locale `info.magnolia.cms.core.AggregationState#getLocale` as part of cache key. |
| `useChannel` | `true` | Use channel `info.magnolia.cms.core.AggregationState#getChannel` as part of cache key. |

#### [](#_client_browser_cache_policy)Client (browser) cache policy

Allows for different policies for different content types. [Voters](../../../../Administration/Architecture/Configuration-management/) are used to define the caching rules.

These policies define how long the browser may cache each content type. The time is passed to the browser in the response header.

-   info.magnolia.module.cache.browsercachepolicy.FixedDuration instructs the browser to cache the content for the specified length of time in minutes.

-   info.magnolia.module.cache.browsercachepolicy.Never instructs the browser to do nothing.


> **Tip:** Client cache policy is configured in /modules/cache/config/contentCaching/defaultPageCache/browserCachePolicy.

##### [](#_cache_control_directives)Cache-Control directives

Using the `directives` property, you can also specify standard [`Cache-Control` directives](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Cache-Control#cache_directives).

> **Note:** The directives property is only applied to info.magnolia.module.cache.browsercachepolicy.FixedDuration.

**Example configuration**

| Node name | Value |
| --- | --- |
| â¸¬ defaultPageCache |     |
| â¸¬ browserCachePolicy |     |
| â¸¬ policies |     |
| â¸¬ disableBrowserCacheInDevelopMode |     |
| â¸¬ voters |     |
| â¸¬ developMode |     |
| â¬© class | info.magnolia.voting.voters.PropertyVoter |
| â¬© property | magnolia.develop |
| â¬© value | true |
| â¬© class | info.magnolia.module.cache.browsercachepolicy.FixedDuration |
| â¸¬ farFuture |     |
| â¬© class | info.magnolia.module.cache.browsercachepolicy.FixedDuration |
| â¬© expirationMinutes | 525600 |
| â¸¬ voters |     |
| â¸¬ resources |     |
| â¬© class | info.magnolia.module.cache.browsercachepolicy.FixedDuration |
| â¬© expirationMinutes | 60  |
| â¸¬ voters |     |
| â¬© op | OR  |
| â¸¬ dotResources |     |
| â¬© class | info.magnolia.voting.voters.URIStartsWithVoter |
| â¬© pattern | /.resources/ |
| â¸¬ contentType |     |
| â¬© class | info.magnolia.voting.voters.RequestExtensionVoter |
| â¬© emptyExtensionVote | false |
| â¸¬ allowed |     |
| â¬© css | css |
| â¬© js | js  |
| â¸¬ dontCachePages |     |
| â¬© class | info.magnolia.module.cache.browsercachepolicy.Never |
| â¸¬ voters |     |
| â¸¬ default |     |
| â¬© class | info.magnolia.module.cache.browsercachepolicy.FixedDuration |
| â¬© directives | public, max-age=604800, immutable |
| â¬© expirationMinutes | 10  |
| â¬© class | info.magnolia.module.cache.browsercachepolicy.BrowserCachePolicySet |

> **Note:** Since Magnolia 6.2.34, the emptyExtensionVote property can control the behavior of the RequestExtensionVoter class in case the request URL has no extension. The default value is true.

#### [](#_flush_policy)Flush policy

The flush policy defines when to flush the cache. There are three policies, two of which are installed by default.

**Flush upon changes from content publication**

The default policy is `info.magnolia.module.cache.flushpolicy.FlushAllFromPublishingEventPolicy`, and you can set it via `/modules/cache/config/contentCaching/defaultPageCache/flushPolicy/policies/flushAll@class`.

This configuration flushes the cache whenever a publishing event is completely finished.

The cache can only be flushed completely. Each module can register its own flush policy (or multiple policies) and receive events in each workspace. Flush policies are informed about notifications from the publication module. By default, all workspaces are allowed to flush unless theyâ€™re listed under the `excludedWorkspaces` subnode. Alternatively, you can list the allowed workspaces per policy under the `workspaces` subnode of each policy.

**Flush upon changes in workspaces**

This configuration observes changes (content publication, import, edit) in a workspace and flushes the cache if new or modified content is detected.

The cache can be flushed completely, partially or not at all. Each module can register its own flush policy (or multiple policies) and receive notifications about new or modified content in each workspace. Flush policies are informed about changes in observed workspaces. By default, all workspaces trigger a cache flush unless theyâ€™re listed under the `excludedWorkspaces` subnode.

> **Tip:** Performance aspectsTo improve performance, list the observed workspaces per policy under the workspaces subnode of each policy.If your custom workspace doesnâ€™t affect the content of pages, you should register it under excludedWorkspaces, otherwise, a change in that workspace unnecessarily flushes the cache.

To enable this configuration, set `/modules/cache/config/contentCaching/defaultPageCache/flushPolicy/policies/flushAll@class` to `info.magnolia.module.cache.FlushAllListeningPolicy`.

**Flush upon changes in light modules**

> **Warning:** Magnolia 5.6.1+: A change in the light modules folder may also flush the server cache. See /modules/cache/config/contentCaching/defaultPageCache/flushPolicy/policies/lightModule/pathToCacheMappings/defaultPageCache with the pattern property, which specifies the pattern for the operation. The default value is ./(templates|webresources|i18n)/.. Node nameValueâ¸¬ defaultPageCacheÂ Â Â Â  â¸¬ flushPolicyÂ Â Â Â Â Â Â Â  â¸¬ policiesÂ Â Â Â Â Â Â Â Â Â Â Â  â¸¬ flushAllÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  â¸¬ excludedWorkspacesÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  â¬© forumforumÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  â¬© imagingimagingÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  â¬© magnolia-mgnlSystemmagnolia-mgnlSystemÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  â¬© magnolia-mgnlVersionmagnolia-mgnlVersionÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  â¬© messagesmessagesÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  â¬© profilesprofilesÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  â¬© usersusersÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  â¬© classinfo.magnolia.module.cache.FlushAllListeningPolicyÂ Â Â Â Â Â Â Â Â Â Â Â  â¸¬ lightModulesÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  â¸¬ defaultPageCacheÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  â¬© cacheNamedefaultPageCacheÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  â¬© pattern.*/(templateswebresourcesi18n)/.*Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  â¬© classinfo.magnolia.module.cache.flushpolicy.LightModuleChangesFlushPolicyÂ Â Â Â Â Â Â Â  â¬© classinfo.magnolia.module.cache.DelegateFlushPolicy

#### [](#_executors)Executors

These are actions taken once a caching decision is made. There are three possible actions:

1.  `useCache`: Retrieves the cached item from the cache and streams it to the client.

2.  `store`: Stores the response in the cache for future use.

3.  `bypass`: Skips caching. This is useful for content that canâ€™t or shouldnâ€™t be cached.


> **Tip:** Executors can be configured at /modules/cache/config/contentCaching/defaultPageCache/executors. Each of the executors is also responsible for configuring expiration headers.

| Node name | Value |
| --- | --- |
| â¸¬ defaultPageCache |     |
| â¸¬ executors |     |
| â¸¬ bypass |     |
| â¸¬ store |     |
| â¸¬ useCache |     |

##### [](#_cacheable_response_codes)Cacheable response codes

By default, all cacheable response codes are cached. For a full list, see [RFC-7231: Overview of Status Codes](https://www.rfc-editor.org/rfc/rfc7231#section-6.1) and [RFC 7233: 206 Partial Content](https://www.rfc-editor.org/rfc/rfc7233#section-4.1).

Using the `cacheableResponseCodes` property, you can define exactly which codes you want cached.

```yaml
...
defaultPageCache:
  executors:
    store:
      cacheContent:
        cacheableResponseCodes: 200,300,400 (1)
...
```

|     |     |
| --- | --- |
| **1** | Where `200`, `300`, and `400` are cached only. |

##### [](#_response_headers_in_redirect_requests)Response headers in redirect requests

Setting `cacheHeadersInRedirects` to `true` allows headers to be included in the response of the redirect request (`302`).

```yaml
...
defaultPageCache:
  executors:
    store:
      cacheContent:
        cacheHeadersInRedirects: true (1)
...
```

|     |     |
| --- | --- |
| **1** | By default, the property is set to `false` to keep the behavior consistent with the previous versions. |

##### [](#_whitelisting_headers_to_be_included_in_a_cache_key)Whitelisting headers to be included in a cache key

Under `allowedRequestHeaders`, you can list headers that can be included in a cache key.

```yaml
...
defaultPageCache:
  cachePolicy:
    cacheKeyGenerator:
      allowedRequestHeaders:
        x-my-header: x-my-header (1)
...
```

|     |     |
| --- | --- |
| **1** | The `x-my-header` is allowed in this example, but the list is empty by default. |

### [](#_compression)Compression

Compression is a simple and effective way to save bandwidth and speed up your site. Itâ€™s a common practice used by Google and Yahoo! for example. ([How to Optimize Your Site with GZIP Compression](http://betterexplained.com/articles/how-to-optimize-your-site-with-gzip-compression/) is a great general introduction to the topic).

Compression is performed in the gzip filter, configured in `/server/filters/gzip`}. When a client requests a resource such as `index.html`, Magnolia delivers it zipped. A typical HTML page is compressed to 20% of its original size. So if your page is 100 kB uncompressed, itâ€™s 20 kB compressed. To improve performance further, zipped content is streamed from the repository to the client rather than read into memory first.

#### [](#_configuring)Configuring

You can configure which content types to compress. By default, the gzip filter bypasses compression for HTML, JavaScript and CSS because theyâ€™re explicitly selected for compression in the Cache module configuration. These types can be compressed efficiently because theyâ€™re text. The decision to compress a particular content type is made with voters. Voters are used whenever configuration values arenâ€™t assigned at startup but depend on rules instead. In the Cache module configuration there are three voting rules based on content type:

-   `text/html`: HTML.

-   `application/x-javascript`: JavaScript.

-   `text/css`: Cascading Style Sheets.


| Node name | Value |
| --- | --- |
| ðŸ“ cache |     |
| ðŸ“ config |     |
| â¸¬ compression |     |
| â¸¬ voters |     |
| â¸¬ contentType |     |
| â¸¬ allowed |     |
| â¬© 1 | text/html |
| â¬© 2 | application/x-javascript |
| â¬© 3 | text/css |
| â¬© class | info.magnolia.voting.voters.RequestExtensionVoter |

To add more content types, such as XML, create a numbered property under `allowed`. Use the Internet media type (MIME type) as value. Here are some [common media types](http://en.wikipedia.org/wiki/Internet_media_type#List_of_common_media_types):

-   `application/xhtml-xml`: XHTML.

-   `text/csv`: Comma-separated value.

-   `text/plain`: Textual data.

-   `text/xml`: Extensible Markup Language.

-   `application/pdf`: Portable Document Format.


> **Note:** As a rule, compressing the HTML, JavaScript and CSS is sufficient; itâ€™s not necessary to compress binary content such as images. During the process, the browser sends a header telling the server that it accepts compressed content: Accept-Encoding: gzip. Note that Magnolia doesnâ€™t cache big binaries.

#### [](#_testing_compression)Testing compression

To test your compression configuration, use a tool such as [Web-Sniffer](http://websniffer.cc/) that allows you to change the `Accept`, `Encoding` and `User-Agent` sent headers easily. Hereâ€™s what the headers look like when the [Magnolia demo site](http://demopublic.magnolia-cms.com/demo-project) home page [is submitted](http://web-sniffer.net/?url=http%3A%2F%2Fdemopublic.magnolia-cms.com%2Fdemo-project.html&submit=Submit&http=1.1&gzip=yes&type=GET&uak=3)^ to the sniffer.

Request header

```none
GET /demo-project.html HTTP/1.1 Host: demopublic.magnolia-cms.com
Connection: close User-Agent: Mozilla/5.0 (Windows; U; Windows NT 5.1;
de; rv:1.9) Gecko/2008052906 Firefox/3.0 Accept-Encoding: gzip
Accept-Charset: ISO-8859-1,UTF-8;q=0.7,*;q=0.7 Cache-Control: no
Accept-Language: de,en;q=0.7,en-us;q=0.3 Referer: http://web-sniffer.net
```

Response header

```none
Status: HTTP/1.1 200 OK Date: Fri, 23 Jul 2010 07:45:10 GMT Server:
Apache/2.2.9 X-Magnolia-Registration: Registered Cache-Control:
max-age=900 Last-Modified: Thu, 01 Jul 2010 14:03:12 GMT
Content-Encoding: gzip Vary: Accept-Encoding Content-Length: 3852
Connection: close Content-Type: text/html;charset=UTF-8
```

### [](#_cache_threshold)Cache threshold

Cache threshold is used to determine if a response should be cached or not according to its size. Responses greater than the size configured arenâ€™t cached.

#### [](#_configuring_2)Configuring

Since Magnolia 6.2.31, you can configure the threshold value at `/modules/cache/config@cacheResponseThreshold`. The value must be an integer and represents **kilobytes**.

The following is an example configuring the threshold to one megabyte.

| Node name | Value |
| --- | --- |
| ðŸ“ modules |     |
| ðŸ“ cache |     |
| ðŸ“ config |     |
| â¸¬ compression |     |
| â¸¬ cacheFactory |     |
| ðŸ“ contentCaching |     |
| â¬© cacheResponseThreshold | 1000 |

> **Caution:** Raising the threshold probably increases the amount of cached content, which uses additional system resources.To control usage, you can configure the cache to use a fixed amount of memory. See the resourceUnit and size properties described in Ehcache 3 module: Configuration.For example, you can set resourceUnit to GB and size to 1.

> **Note:** You can set this value programatically, for example, in your custom renderer which does time-consuming operations:MgnlContext.getWebContext().getRequest().setAttribute(CacheResponseWrapper.ATTRIBUTE_IN_MEMORY_THRESHOLD, CacheResponseWrapper.DEFAULT_THRESHOLD * 2);You need to set this attribute before anything is written to the output.

### [](#_advanced_strategies)Advanced strategies

In DX Core, advanced caching strategies are available in separate [Advanced Cache modules](../../Advanced-cache-modules/).

## [](#_commands)Commands

Cache related commands are in the `cache` catalog:

-   `flushAll`: Completely flushes all caches. (Note that the imaging workspace - which technically is not a cache - is not flushed with this command.)

-   `flushByUUID`: Completely flushes all entries related to a given UUID from all available caches. This command expects `repository` and `uuid` as parameters.

-   `flushNamedCache`: Completely flushes a cache by name. Default cache names are `default` and `uuid-key-mapping`.


## [](#_cached_urls)Cached URLs

By default, the following URLs are cached:

-   On public instance everything except `/.magnolia/*` which is AdminCentral.

-   On author instance all static resources `/.resources/*` if `magnolia.develop` property is set to `false`.


## [](#_cache_strategies)Cache strategies

The system caches resources such as JavaScript files and CSS files on the author instance by default to make authoring more responsive. Disable this behavior when developing. Set the `magnolia.develop` property to `true` in the default `magnolia.properties` file. For more complex configurations, you need to adjust the configuration under the `/modules/cache/config/contentCaching/defaultPageCache/cachePolicy` node

### [](#_excluding_content_from_cache)Excluding content from cache

There are various reasons why you may wish to exclude content from cache. For example, you may have components that query an external data source dynamically. The rendered HTML changes even if the content of the Magnolia page has not changed. When we say *cached content* we mean the rendered output generated by Magnolia itself, the actual content of the page. When you exclude a page from cache you tell Magnolia that it should re-render that content every time the page is requested by a user.

#### [](#_configuring_an_exclusion)Configuring an exclusion

The first option for excluding content from cache is to configure an exclusion in the [cache policy](#_policy_configuration). The example below excludes all pages whose URL starts with `/.magnolia`. This means that AdminCentral pages are not cached.

| Node name | Value |
| --- | --- |
| ðŸ“ cache |     |
| ðŸ“ config |     |
| ðŸ“ contentCaching |     |
| â¸¬ cachePolicy |     |
| â¸¬ shouldBypassVoters |     |
| â¸¬ urls |     |
| â¸¬ includes |     |
| â¸¬ excludes |     |
| â¸¬ dotMagnolia |     |
| â¬© class | info.magnolia.voting.voters.URIStartsWithVoter |
| â¬© pattern | /.magnolia |
| â¬© not | true |
| â¬© level | 1   |

#### [](#_implementing_a_custom_cache_policy)Implementing a custom cache policy

To create a custom cache policy, implement the info.magnolia.module.cache.CachePolicy interface and override the methods you wish to customize. The default policy:

> determines if a requested page should be cached, retrieved from the cache or not cached at all. It is called for every request and takes care of any expiration policy, that is if the page should be re-cached. The CacheFilter (or any other client component) can determine its behavior based on the return CachePolicyResult, which holds both the behavior to take and the cache key to use when appropriate.

Configure your custom cache policy class in `/modules/cache/config/configuration/default/cachepolicy`.

#### [](#_cache_header_negotiation)Cache header negotiation

Cache header negotiation is a mechanism that allows templates and components to influence whether the content should be cached and for how long. This mechanism can be used when it is too late to configure an exclude, but you do not wish for a page to be cached. Excludes are typically configured before it is clear what kinds of pages editors will add and what kind of content those pages will have. Cache header negotiation allows page components to influence whether the page should be cached. You can use cache header negotiation for:

-   **Live, dynamic data**: A component that displays dynamic data can indicate that the page the component is, or should be, cached only for a short duration: 5 minutes, 1 minute, etc.

-   **Personalized content**. Components that display personalized content can indicate that the page should not be cached at all.

-   **Error resolution**: If a component fails to read data from an external source and outputs a message to say there is a problem, you may not want to cache the error message, at least not for long. Instead, it is better if the component makes another attempt at getting the data when the next visitor requests the page. When you configure caching in many components, remember that the strictest criteria wins. If a page has a component that indicates that content should not be cached, the page will not be cached regardless of what components say. For example, if the live data and personalization components mentioned above are added on the same page, the page wonâ€™t be cached at all. A template can influence the decision in the same way. A template might want to cache the page for 10 minutes because the page displays real-time weather updates. If a component on the page wants to be cached for a maximum of 15 minutes, the templateâ€™s instructions win because they are stricter. The page is cached for 10 minutes.


#### [](#_other_options)Other options

The following options are not best practices but they may help you during testing. Donâ€™t use them as a long-term production strategy.

-   **Dummy URL parameter**: The simplest way to exclude content is to link to the relevant page with a dummy query parameter in the URL such as `[http://www.example.com?a=1](http://www.example.com?a=1)`. A more subtle solution is to add `bypass` to the [cache filter](../../../../Administration/Architecture/Request-processing-and-filters/Filters/). This ensures that no cache filter is executed on particular URLs.

-   **Deny URLs in cache policy**: To exclude a URL from caching, add the URL to the `deny` list of the cachePolicy. Entries on the `deny` list are not cached by Magnolia but are taken through the entire filter chain, meaning that other policies such as `BrowserCachePolicy` can still be applied. In effect, this solution switches off caching for the URL in question.

-   **Regular cache flush**: Flush a page from the cache at regular intervals. This involves reconfiguring the underlying cache engine.


## [](#_setting_cache_headers)Setting cache headers

Cache header negotiation uses standard cache response headers. Cache needs to be enabled for the site or cache headers have no effect on the server side cache. The mechanism is built into the Cache module and requires no extra modules. Cache header negotiation is being introduced to Magnolia in two phases:

### [](#_in_code)In code

In code, developers set the cache headers in the rendering model of a component or a template. This is the current implementation.

**Example 1**: Setting a cache header in Java code, snippet from info.magnolia.module.form.templates.components.AbstractFormModel.

MgnlContext.getWebContext().getResponse().setHeader("Cache-Control", "no-cache");

**Example 2**: Setting a cache header in a FreeMarker template script.

${ctx.response.setHeader("Cache-Control", "no-cache")}

### [](#_in_page_properties_dialog)In page properties dialog

Since the release of Magnolia 6.2.2, the `basic` page [template in the Magnolia Templating Kit](../../../../Developing/Templating/Templates-in-MTK/) (MTK) allows you to control page caching through the **No Cache** checkbox in the Page properties dialog (the **Meta Data** tab):

![Page properties dialog](../../../../_images/6-2-30-cacheCore-noCacheCheckboxBoxed.png)

The checkbox is defined using the `noCache` field in the [basic.yaml](https://gitlab.magnolia-platform.com/pd/modules/templating-essentials/-/blob/master/magnolia-templating-kit-2/src/main/resources/mtk2/dialogs/pages/basic.yaml) dialog definition file. If checked, the [htmlHeader.ftl](https://gitlab.magnolia-platform.com/pd/modules/templating-essentials/-/blob/master/magnolia-templating-kit-2/src/main/resources/mtk2/templates/areas/htmlHeader.ftl) area template script sets the header.

### [](#_enhanced_private_cache_control_header)Enhanced `private` Cache-Control header

To prevent caching of sensitive form data, use the `private` directive in the `Cache-Control` header, such as `private, no-cache, no-store`.

**Examples**

Setting a cache header with the `private` directive in Java code:

```java
MgnlContext.getWebContext().getResponse().setHeader("Cache-Control", "private, no-cache, no-store");
```

Setting a cache header with the `private` directive in a FreeMarker template script:

```xml
${ctx.response.setHeader("Cache-Control", "private, no-cache, no-store")}
```

## [](#_security_aspects)Security aspects

### [](#_web_cache_poisoning)Web Cache Poisoning

When creating page templates, developers often need to use various types of input such as

-   content,

-   language,

-   request parameters,

-   user information (for authentication).


Magnolia takes care of all of these attributes and includes them in cache keys to ensure that unique cache entries are generated for all attribute variants occurring.

Sometimes, however, it may be unavoidable to use more exotic or less obvious variables such as specific header values, date/time values or other types of input. When using such parameters, developers must consider their impact on the validity of cache to prevent [Web Cache Poisoning](https://portswigger.net/research/practical-web-cache-poisoning) attacks.

#### [](#_example)Example

Imagine using an [HTTP referer](https://en.wikipedia.org/wiki/HTTP_referer) header to change a teaser image link on a page. Once the image is rendered, it is - by default - cached and used for all the other incoming requests,

-   as long as the cache entry is valid,

-   and regardless of referer headers of those requests.


Depending on the content rendered it might or might not be an issue, but a case of Web Cache Poisoning occurs if somebody passes malicious content through a referer header that is trusted by and rendered for all the other incoming requests.

#### [](#_prevention)Prevention

Always consider the character and the origin of the input entering the process of rendering a response. For any original request input,

-   either the input must be included in the cache key, to allow Magnolia to generate an independent cache entry from it,

-   or the component rendering such content needs to be marked as dynamic and excluded from the cache (see [Dynamic page caching](../../High-performance-caching-modules/Advanced-Cache-Dynamic-Page-Caching/#_dynamic_page_caching) for more details),

-   or else the whole page needs to be excluded from the cache.
