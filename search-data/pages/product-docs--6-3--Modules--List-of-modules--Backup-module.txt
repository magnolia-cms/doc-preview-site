---
title: "Backup module"
url: https://docs.magnolia-cms.com/product-docs/6.3/Modules/List-of-modules/Backup-module/
category: Magnolia 6.3
version: 6.3
breadcrumb: DX Core > Modules > Backup module
---

# Backup module

[Content management](../../../use-cases/content-management/) Bundled: Extension

|     |     |
| --- | --- |
| Edition | DX Core |
| License | [MLA](https://www.magnolia-cms.com/mla.html) |
| Issues | [MGNLBACKUP](https://magnolia-cms.atlassian.net/browse/MGNLBACKUP) |
| Maven site | [Backup](https://nexus.magnolia-cms.com/#browse/browse:enterprise:info%2Fmagnolia%2Fmagnolia-module-backup%2F2.5.1) |
| Latest | 2.5.1 |

The Backup module allows you to create manual and automatic content and configuration data backups. The module backs up the configuration of the respective Magnolia [instance](../../../Administration/Instances/) on which it runs and all versions of content stored in all its workspaces.

You can manage both manual and automatic backups in the Backup [app](../../../Apps/List-of-apps/Backup-app/). Scripts can [back up](#_backup_script) and [restore](#_restoring_a_backup) content and configuration data flexibly by specifying various backup and restore options.

> **Caution:** Using the Backup module should mainly be reserved for specific cases such as cross-platform dumps and small databases. A cross-platform dump might be backing up on a Jackrabbit configuration and restoring on possibly another Jackrabbit configuration.For production environments, we recommend you use both database tools and file system copies (the contents of any file stored and optionally Lucene indexes) to have consistent and transaction-safe backups.

> **Note:** Most of your content is stored in a database, and you can use database tools to back up and restore your JCR content. However, some high-level steps to remember when backing up your content are outlined here.

![Backup app](../../../_images/6-2-backupModule.png)

## [](#_installing_with_maven)Installing with Maven

Maven is the easiest way to install the module. Add the following to your [bundle](../../../Developing/Bundles-and-webapps/):

```xml
<dependency>
  <groupId>info.magnolia</groupId>
  <artifactId>magnolia-module-backup</artifactId>
  <version>2.5.1</version> (1)
</dependency>
```

|     |     |
| --- | --- |
| **1** | Should you need to specify the module version, do it using `<version>`. |

## [](#_backup_app)Backup app

The [Backup app](../../../Apps/List-of-apps/Backup-app/) allows you to [create manual backups](#_creating_manual_backups), [schedule automatic backups](#_scheduling_automatic_backups) and [manage existing backup tasks](#_managing_existing_tasks). The app creates a backup of the entire Magnolia installation.

### [](#_creating_manual_backups)Creating manual backups

To create a manual backup:

1.  Create a target backup directory on the file system.

2.  Under **Manual backup**, enter the path to your backup directory. The path must be absolute.

3.  Click **Backup**.


![Manual backup](../../../_images/6-1-backupModule-createManualBackup.png)

Below is the structure of a backup folder once a backup is created.

└───<target directory>
    ├───repository
    │   ├───datastore
    │   ├───meta
    │   ├───namespaces
    │   ├───nodetypes
    │   └───privileges
    ├───version
    │   └───db
    └───workspaces
        ├───category
        │   └───db
        ├───config
        │   └───db
        ├───...
        └───workflow
            └───db
    ├───repository.xml

The following table explains the backup folder contents.

|     |     |
| --- | --- |
| `<backup folder>` |     |
| `respository` | Subfolders containing data store and configuration files necessary to restore the repositories. |
| `version` | Version database. Contains versions of all versionable content from all repositories. |
| `workspaces` | One folder per workspace. Holds all content of a given workspace. |
| `repository.xml` | Repository configuration file. |

> **Warning:** Backup files contain confidential information on how to connect to the database. Keep your backup files in a secure location.

### [](#_scheduling_automatic_backups)Scheduling automatic backups

To schedule an automatic backup:

1.  Under **Automatic backup**, set the time, frequency and target directory.

2.  Click **Schedule backup**.


![Automatic backup](../../../_images/6-1-backupModule-createAutoBackup.png)

Automatic backup tasks are registered in `/modules/backup/config`.

![Backup module configuration](../../../_images/ADVT-backup-mod.png)

| Property | Description |
| --- | --- |
| `config` | **optional**<br><br>Module configuration node. |
| `tasks` | **optional**<br><br>Tasks folder. |
| `backupTasks` | **required**<br><br>Task configuration node. |
| `automatedExecution` | **required**<br><br>Automatic execution node. |
| `cron` | **required**<br><br>CRON expression that sets the scheduled execution time. |
| `enabled` | **optional**, *default is `false`*<br><br>Enables and disables the task. |
| `class` | **required**<br><br>info.magnolia.module.backup.AutomatedBackupConfiguration is the bean that holds the backup configuration. |
| `name` | **required**<br><br>Task name. |
| `targetPath` | **required**<br><br>Path to the backup directory. The path must be absolute.<br><br>Automatic backups include a timestamp in the backup folder. |

### [](#_managing_existing_tasks)Managing existing tasks

Under **Existing tasks**, you can view and delete scheduled automatic backups.

![Existing tasks](../../../_images/6-1-backupModule-existingTasks.png)

## [](#_backup_script)`Backup` script

For backing up Magnolia, the `backup` script provides more flexibility and options, such as launching a backup from a running Magnolia instance.

The script is in the `bin` folder in the Backup module **bundle**. You can obtain the bundle from the Magnolia Nexus.

After you log in to Nexus, use the **Search** > **Maven** navigation menu option to search for the bundle (in tar.gz. or .zip format) using the following Maven coordinates:

```xml
<dependency>
  <groupId>info.magnolia</groupId>
  <artifactId>magnolia-module-backup</artifactId>
  <version>2.5.1</version>
</dependency>
```

If you choose to use the script:

-   Make sure that the library versions in the target webapp after a restoration update are the same as those in the Magnolia instance you are currently running.

-   Run the script in a CLI.


Usage:

./bin/backup \[options\]

  ShortLongDescription

`-c <arg>`

`--configuration <arg>`

**required**

Location of the repository configuration.

> **Note:** By default, Derby is the database configured out of the box. Several configuration files are included in your installation’s apache-tomcat/webapps/magnoliaAuthor/WEB-INF/config/repo-conf folder. Make sure you specify the file that best fits your database, for example, jackrabbit-bundle-derby-search.xml for Derby.

`-r <arg>`

`--repository <arg>`

**required**

Location of the repository to back up.

`-t <arg>`

`--target <arg>`

**required**

Target location for the backup.

`-mr <arg>`

`--maxRetries <arg>`

**optional**

Maximum number of retries when encountering an exception.

`-rt <arg>`

`--retryTimeout <arg>`

**optional**

Interval in seconds for retrying the backup when an exception occurs.

`-u <context> <username:password>`

`--user <context> <username:password>`

**optional**

Context, username and password. Used for launching a backup from a running Magnolia instance with a given username, password and host URL.

> **Note:** This option only works if the user has been assigned the rest-backup role. See Backup REST service.

`-z`

`--zip`

**optional**

Creates a compressed ZIP archive.

`-zp <arg>`

`--zipPath <arg>`

**required** when `-z` is used

Location for a zip backup archive. The argument must be a file with a path.

The path must be absolute in the context of the Backup module (for example, `-z -zp /tmp/magnolia-backup.zip`).

**Example**: Launching a backup from a running Magnolia instance.

```sh
./bin/backup -t /tmp/backup/backup-some/01 -r /Users/Name/Workspace/dev-project/magnolia-dev-webapp/target/magnolia-dev-webapp-1.0/repositories/magnolia -c /Users/Name/Workspace/dev-project/magnolia-dev-webapp/target/magnolia-dev-webapp-1.0/WEB-INF/config/repo-conf/jackrabbit-bundle-derby-search.xml -u http://localhost:8080 superuser:superuser
```

> **Warning:** Although it’s possible to back up from a running Magnolia instance, it’s not recommended as a best practice. To ensure stability and prevent potential inconsistencies caused by nodes being published (versioned) during the backup process, avoid this option if possible. See Backup REST service.

## [](#_restoring_a_backup)Restoring a backup

To restore the previously backed up data, use the `restore` script in the `bin` folder in the [Backup module bundle](https://nexus.magnolia-cms.com/repository/enterprise/info/magnolia/magnolia-module-backup/2.5.1/magnolia-module-backup-2.5.1-bundle.zip). The `restore` script needs to be run in a CLI.

The `restore` script is meant to re-create an instance, not to patch an existing one.

For it to work correctly, you need to:

-   Clean your database schema before running the script.

-   Run the script before starting Magnolia so that the script can recreate the repository.


To make sure the `webapp` directory is set up before running the `restore` script, we recommend you take the WAR file or webapp from the bundle, add all your custom modules, start up the server once and perform the installation. Create a backup of this new instance before shutting down the server, deleting the `repositories` directory and running the restore as specified below.

Usage

```none
/restore [options]
```

| Short | Long | Description |
| --- | --- | --- |
| `-c` | `--configuration <arg>` | **required**<br><br>Location of the repository configuration.<br><br>`magnolia.repositories.jackrabbit.config` property. |
| `-r` | `--repository <arg>` | **required**<br><br>Location of the repository to restore.<br><br>`magnolia.repositories.home` property followed by the repository name (default: `magnolia`). |
| `-s` | `--source <arg>` | **required**<br><br>Source location of the backup. |
| `-z` | `--zip` | **optional**<br><br>Restores from a compressed ZIP archive. |

**Example**:

```sh
./bin/restore -r /Users/Name/Workspace/dev-project/magnolia-dev-webapp/target/magnolia-dev-webapp-1.0/repositories/magnolia -s /magnoliaBackups/Sept2016/01 -c /Users/Name/Workspace/dev-project/magnolia-dev-webapp/target/magnolia-dev-webapp-1.0/WEB-INF/config/repo-config/jackrabbit-bundle-mysql-search.xml
```

> **Tip:** Assign the restore script more memory by changing the EXTRA_JVM_ARGUMENTS variable in the script file. On a Linux server, you need to grant the correct permissions to the script file to run it.It’s not necessary to reindex your repository when you run the restore script.

> **Note:** For safety reasons, run the restore from time to time on a test system to verify the validity of the backup files. Depending on the amount of data changed over time, do this every month or every quarter.

### [](#_database_size)Database size

During restore, all entries are reinserted into the database sequentially. This ensures that the restored database is not fragmented and is slightly smaller than the equivalent database before backup.

### [](#_changing_persistence_managers)Changing persistence managers

You can use backup and restore to migrate data to another persistence manager and to another database. For example, you can change from Derby to MySQL.

To change persistence managers, use the `-c <arg>` (`--configuration <arg>`) option to point to the new configuration.

**Example**:

./bin/restore -c /Users/Name/Workspace/dev-project/magnolia-dev-webapp/target/magnolia-dev-webapp-1.0/WEB-INF/config/repo-config/jackrabbit-bundle-mysql-search.xml

## [](#_backup_command)`Backup` command

The `backup` command starts the execution of both [manual](#_creating_manual_backups) and [automatic](#_scheduling_automatic_backups) backups.

The command is registered in `/modules/backup/commands/backup/backup`.

![Backup command](../../../_images/ADVT-backup-mod-cmd.png)

| Property | Description |
| --- | --- |
| `commands` | **optional**<br><br>Commands folder. |
| `backup` | **required**<br><br>Backup [catalog](../../../Developing/Commands/#_catalogs). |
| `backup` | **required**<br><br>[Command](../../../Developing/Commands/) name. |
| `class` | **required**<br><br>info.magnolia.module.backup.commands.BackupCommand starts the execution of both [manual](#_creating_manual_backups) and [automatic](#_scheduling_automatic_backups) backups. |
| `repositoryPath` | **required**, *default is `magnolia.repositories.home`*<br><br>Location of the repository to back up. |
| `configurationPath` | **required**, *default is `magnolia.repositories.jackrabbit.config`*<br><br>Location of the repository configuration. |
| `backupLocation` | **required**<br><br>Target location for the backup. |
| `compression` | **optional**, *default is `false`*<br><br>When `true`, the backup is compressed in a ZIP archive. |
| `retryTimeout` | **optional**, *default is `30`*<br><br>Interval in seconds for retrying the backup when an exception occurs. |
| `maxRetries` | **optional**, *default is `3`*<br><br>Maximum number of retries when encountering an exception. |

## [](#_backup_rest_service)Backup REST service

The `backup` command is executed with a REST call. This allows observation of the `mgnlVersion` workspace and prevents potential inconsistencies if a node is published (versioned) during the backup process. If an inconsistency is detected, the backup will stop and retry 3 times (the default value for `maxRetries`). If the inconsistency persists, the backup will fail and this will be logged to the user.

The `backup` command is enabled as a REST endpoint in the [REST Services module](#3.1@rest:ROOT:index.adoc) in `/modules/rest-services/rest-endpoints/commands/enabledCommands/backup`.

![Backup REST](../../../_images/ADVT-backup-mod-rest.png)

| Property | Description |
| --- | --- |
| `enabledCommands` | **required**<br><br>Enabled commands node. |
| `backup` | **required**<br><br>Command node. The name is arbitrary. |
| `access` | **required**<br><br>Access node. |
| `roles` | **required**<br><br>Roles node. |
| `rest-backup` | **required**<br><br>Role name. Grants the `rest-backup` role permission to execute the command. The property name is arbitrary, but the value must be a valid role name. |
| `catalogName` | **required**<br><br>[Catalog](../../../Developing/Commands/#_catalogs) where the command resides. |
| `commandName` | **required**<br><br>[Command definition](../../../Developing/Commands/) name. |

The Backup module adds the `rest-backup` role to the [Security app](../../../Apps/List-of-apps/Security-app/). The role allows the execution of the `backup` command from a running Magnolia instance and has the following web access permission:

|     |     |
| --- | --- |
| **Permission** | **Path** |
| Get & Post | `/.rest/commands/v2/backup/backup` |

You must use `POST` to send requests to the [`commands` endpoint](../../../Developing/API/Commands-API/).

> **Important:** You have to define the backup command properties in the request body as described above.

## [](#_issues)Issues

### [](#_ant_malformed_uxxxx_encoding_in_a_propertyfile_task)Ant: Malformed \\uxxxx encoding in a propertyfile task

You may encounter the following error:

```console
1) [Guice/ErrorInjectingConstructor]: IllegalArgumentException: Malformed \\uxxxx encoding.
  at DefaultMessageBundlesLoaderProvider.<init>(DefaultMessageBundlesLoaderProvider.java:50)
  while locating DefaultMessageBundlesLoaderProvider
  at GuiceComponentConfigurationModule.bindProvider(GuiceComponentConfigurationModule.java:187)
      \\_ installed by: Modules$OverrideModule -> Modules$OverrideModule -> GuiceComponentProviderBuilder$1 -> GuiceComponentConfigurationModule
  while locating DefaultMessageBundlesLoader
```

Debug to find the properties file which caused this error, enable it through the `log4j2.xml`.

```console
<Logger name="info.magnolia.i18nsystem" level="DEBUG"/>
```

**Solution**

1.  Use the correct classpath for SmartTomcat.

2.  Follow [java.lang.IllegalArgumentException: Malformed \\uxxxx encoding while mvn install](https://stackoverflow.com/questions/68003423/java-lang-illegalargumentexception-malformed-uxxxx-encoding-while-mvn-install).
