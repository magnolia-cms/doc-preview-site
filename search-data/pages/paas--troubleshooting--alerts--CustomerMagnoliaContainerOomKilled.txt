---
title: "OOMKilled container"
url: https://docs.magnolia-cms.com/paas/troubleshooting/alerts/CustomerMagnoliaContainerOomKilled/
category: DX Cloud
version: cloud
breadcrumb: DX Cloud > Troubleshoot > OOMKilled container
---

# OOMKilled container

This topic guides you on troubleshooting containers that are being "OOMKilled".

What is OOMKill?

Out of memory kill meaning a container or pod was terminated, because it was using more memory than it was allowed.

## [](#_symptom)Symptom

The `CustomerMagnoliaContainerOOMKilled` alert is firing.

> **Note:** CustomerMagnoliaContainerOOMKilled alerts are sent to subscribers via email.

### [](#_whats_using_the_memory)What’s using the memory?

Kubernetes restarts a pod if it exceeds its memory limit. The Magnolia JVM typically cannot exceed its memory limit - the JVM max heap setting - but the JVM also will consume off heap memory that can vary over time, depending on what Magnolia is doing. Other containers running in the Magnolia pod may also consume memory but they usually use very small amounts (`10s` of `mb`). Temporary filesystems may use memory as well.

| **Expression** | `magnolia:oomkill:interval > 0` |
| --- | --- |
| **Delay** | `0` minutes |
| **Labels** | `team: customer` |
| **Annotations** | • `summary` • `description` • `tenant` • `cluster_id` • `cluster_name` • `instance` • `namespace` |

## [](#_considerations)Considerations

### [](#_jvm_memory_usage)JVM memory usage

The JVM uses more memory than just the heap. Constraining the max heap won’t necessarily stop the JVM from exceeding the memory limit set for the pod.

#### [](#_non_heap_memory_usage)Non-heap memory usage

-   Direct memory allocated with the `java.nio.ByteBuffer.allocateDirect`.

-   Other classes in the `java.nio` library may allocate a direct memory buffer.

-   Classes dealing with compressed streams like `DeflaterInputStream`, `DeflaterOutputStream`, `GZIPInputStream`, `GZIPOutputStream`, `ZipFile`, `ZipInputStream`, and `ZipOutputStream` may allocate a direct memory buffer.

-   Magnolia imaging operations using compressed image formats like `gif` or `webp` may allocate direct memory buffers when resizing or modifying images.


Direct memory buffers may be deallocated when the Java object using it is garbage collected, but a large number requests, such as imaging requests, may cause non-heap memory to be used.

A Magnolia instance that is being OOMKilled frequently will:

-   Have high traffic - many requests per second

-   Have lots of imaging requests in that traffic

-   Have frequent cache flushes or be configured to not cache imaging requests


### [](#_memory_usage_metrics)Memory usage metrics

We have many metrics that monitor the memory used by the JVM and Magnolia pod:

-   `jvm_memory_bytes_used{area="heap"}`: how much memory on the heap is being used

-   `jvm_memory_bytes_used{area="nonheap"}`: how much off heap memory is being used

-   `jvm_memory_bytes_committed{area="heap"}`: how much memory the JVM currently has allocated for the heap

-   `jvm_memory_bytes_committed{area="nonheap"}`: how much memory the JVM currently has allocated for off heap usage

-   `jvm_memory_bytes_max{area="heap"}`: the maximum size of the JVM heap

-   `jvm_memory_bytes_max{area="nonheap"}`: NOT the maximum size of the off heap memory, **is always -1**!


> **Important:** All JVM memory metrics above do not include direct memory usage (off heap) memory used by the JVM. They can’t be used to determine what is consuming heap and off heap memory in the JVM.

#### [](#_usage_metrics)Usage metrics

There are some things to keep in mind about the above metrics.

-   The JVM memory metrics are collected every 60 seconds (1m). They may not reflect sudden spikes in memory usage.

-   The `jvm_memory_bytes_used` (heap and nonheap) metric is memory being used, but it’s not the memory actually being used by the JVM itself. `jvm_memory_bytes_committed` is the amount of memory used by the JVM for heap and off-heap memory.

    -   Heap memory

    -   Off heap memory


    ```none
    jvm_memory_bytes_used < jvm_memory_bytes_committed ≤ jvm_memory_bytes_max (1)
    ```

    |     |     |
    | --- | --- |
    | **1** | The jvm\_memory\_bytes\_max{area="heap"} metric is the maximum size of the JVM heap (as controlled by the JVM options in the Helm chart values). |

    ```none
    jvm_memory_bytes_used < jvm_memory_bytes_committed (1)
    ```

    <1>


### [](#_pod_and_container_combined_memory)Pod and container combined memory

There is another metric that determines the memory used the Magnolia pod and its containers:

-   `container_memory_working_set_bytes`


The same caveats for the JVM memory metrics apply to `container_memory_working_set_bytes`. The `container_memory_working_set_bytes` metric is collected every 60 seconds and may not reflect sudden spikes in memory usage.

The `container_memory_working_set_bytes` metric shows memory usage by container for a pod; it does not know what the memory is being used for (heap, off heap, etc).

> **Note:** container_memory_working_set_bytes seems to be a lagging indicator in that its value doesn’t actually exceed the memory limit for the pod.

| Memory type | Amount |
| --- | --- |
| **JVM Max Heap** | 7.2 GB |
| **Direct memory** | 3.8 GB |
| **Surplus** | 1 GB |
| **Total** | 12 GB |
